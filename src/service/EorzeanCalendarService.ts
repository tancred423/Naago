export class EorzeanCalendarService {
  /**
   * Mapping of Eorzean moon number to Gregorian month number (1-12)
   */
  private static readonly MOON_TO_MONTH: Record<number, number> = {
    1: 1, // First Astral Moon (Halone) -> January
    2: 2, // First Umbral Moon (Menphina) -> February
    3: 3, // Second Astral Moon (Thaliak) -> March
    4: 4, // Second Umbral Moon (Nymeia) -> April
    5: 5, // Third Astral Moon (Llymlaen) -> May
    6: 6, // Third Umbral Moon (Oschon) -> June
    7: 7, // Fourth Astral Moon (Byregot) -> July
    8: 8, // Fourth Umbral Moon (Rhalgr) -> August
    9: 9, // Fifth Astral Moon (Azeyma) -> September
    10: 10, // Fifth Umbral Moon (Nald'thal) -> October
    11: 11, // Sixth Astral Moon (Nophica) -> November
    12: 12, // Sixth Umbral Moon (Althyk) -> December
  };

  /**
   * Mapping of (moon, sun) pairs to Gregorian (month, day) pairs.
   * Format: [moon][sun] = [month, day]
   */
  private static readonly SUN_TO_GREGORIAN: Record<number, Record<number, [number, number]>> = {
    1: { // First Astral Moon -> January
      1: [1, 1],
      2: [1, 2],
      3: [1, 3],
      4: [1, 4],
      5: [1, 5],
      6: [1, 6],
      7: [1, 7],
      8: [1, 8],
      9: [1, 9],
      10: [1, 10],
      11: [1, 11],
      12: [1, 12],
      13: [1, 13],
      14: [1, 14],
      15: [1, 15],
      16: [1, 16],
      17: [1, 17],
      18: [1, 18],
      19: [1, 19],
      20: [1, 20],
      21: [1, 21],
      22: [1, 22],
      23: [1, 23],
      24: [1, 24],
      25: [1, 25],
      26: [1, 26],
      27: [1, 27],
      28: [1, 28],
      29: [1, 28],
      30: [1, 29],
      31: [1, 30],
      32: [1, 31],
    },
    2: { // First Umbral Moon -> February
      1: [2, 1],
      2: [2, 2],
      3: [2, 3],
      4: [2, 4],
      5: [2, 5],
      6: [2, 6],
      7: [2, 7],
      8: [2, 7],
      9: [2, 8],
      10: [2, 9],
      11: [2, 10],
      12: [2, 11],
      13: [2, 12],
      14: [2, 13],
      15: [2, 14],
      16: [2, 14],
      17: [2, 15],
      18: [2, 16],
      19: [2, 17],
      20: [2, 18],
      21: [2, 19],
      22: [2, 20],
      23: [2, 21],
      24: [2, 21],
      25: [2, 22],
      26: [2, 23],
      27: [2, 24],
      28: [2, 25],
      29: [2, 26],
      30: [2, 27],
      31: [2, 28],
      32: [2, 29],
    },
    3: { // Second Astral Moon -> March
      1: [3, 1],
      2: [3, 2],
      3: [3, 3],
      4: [3, 4],
      5: [3, 5],
      6: [3, 6],
      7: [3, 7],
      8: [3, 8],
      9: [3, 9],
      10: [3, 10],
      11: [3, 11],
      12: [3, 12],
      13: [3, 13],
      14: [3, 14],
      15: [3, 15],
      16: [3, 16],
      17: [3, 17],
      18: [3, 18],
      19: [3, 19],
      20: [3, 20],
      21: [3, 21],
      22: [3, 22],
      23: [3, 23],
      24: [3, 24],
      25: [3, 25],
      26: [3, 26],
      27: [3, 27],
      28: [3, 28],
      29: [3, 28],
      30: [3, 29],
      31: [3, 30],
      32: [3, 31],
    },
    4: { // Second Umbral Moon -> April
      1: [4, 1],
      2: [4, 2],
      3: [4, 3],
      4: [4, 4],
      5: [4, 5],
      6: [4, 6],
      7: [4, 7],
      8: [4, 7],
      9: [4, 8],
      10: [4, 9],
      11: [4, 10],
      12: [4, 11],
      13: [4, 12],
      14: [4, 13],
      15: [4, 14],
      16: [4, 15],
      17: [4, 16],
      18: [4, 17],
      19: [4, 18],
      20: [4, 19],
      21: [4, 20],
      22: [4, 21],
      23: [4, 22],
      24: [4, 23],
      25: [4, 24],
      26: [4, 25],
      27: [4, 26],
      28: [4, 27],
      29: [4, 28],
      30: [4, 28],
      31: [4, 29],
      32: [4, 30],
    },
    5: { // Third Astral Moon -> May
      1: [5, 1],
      2: [5, 2],
      3: [5, 3],
      4: [5, 4],
      5: [5, 5],
      6: [5, 6],
      7: [5, 7],
      8: [5, 8],
      9: [5, 9],
      10: [5, 10],
      11: [5, 11],
      12: [5, 12],
      13: [5, 13],
      14: [5, 14],
      15: [5, 15],
      16: [5, 16],
      17: [5, 17],
      18: [5, 18],
      19: [5, 19],
      20: [5, 20],
      21: [5, 21],
      22: [5, 22],
      23: [5, 23],
      24: [5, 24],
      25: [5, 25],
      26: [5, 26],
      27: [5, 27],
      28: [5, 28],
      29: [5, 29],
      30: [5, 29],
      31: [5, 30],
      32: [5, 31],
    },
    6: { // Third Umbral Moon -> June
      1: [6, 1],
      2: [6, 2],
      3: [6, 3],
      4: [6, 4],
      5: [6, 5],
      6: [6, 6],
      7: [6, 7],
      8: [6, 7],
      9: [6, 8],
      10: [6, 9],
      11: [6, 10],
      12: [6, 11],
      13: [6, 12],
      14: [6, 13],
      15: [6, 14],
      16: [6, 15],
      17: [6, 16],
      18: [6, 17],
      19: [6, 18],
      20: [6, 19],
      21: [6, 20],
      22: [6, 21],
      23: [6, 22],
      24: [6, 23],
      25: [6, 24],
      26: [6, 25],
      27: [6, 26],
      28: [6, 27],
      29: [6, 28],
      30: [6, 28],
      31: [6, 29],
      32: [6, 30],
    },
    7: { // Fourth Astral Moon -> July
      1: [7, 1],
      2: [7, 2],
      3: [7, 3],
      4: [7, 4],
      5: [7, 5],
      6: [7, 6],
      7: [7, 7],
      8: [7, 8],
      9: [7, 9],
      10: [7, 10],
      11: [7, 11],
      12: [7, 12],
      13: [7, 13],
      14: [7, 14],
      15: [7, 15],
      16: [7, 16],
      17: [7, 17],
      18: [7, 18],
      19: [7, 19],
      20: [7, 20],
      21: [7, 21],
      22: [7, 22],
      23: [7, 23],
      24: [7, 24],
      25: [7, 25],
      26: [7, 26],
      27: [7, 27],
      28: [7, 28],
      29: [7, 28],
      30: [7, 29],
      31: [7, 30],
      32: [7, 31],
    },
    8: { // Fourth Umbral Moon -> August
      1: [8, 1],
      2: [8, 2],
      3: [8, 3],
      4: [8, 4],
      5: [8, 5],
      6: [8, 6],
      7: [8, 7],
      8: [8, 8],
      9: [8, 9],
      10: [8, 10],
      11: [8, 11],
      12: [8, 12],
      13: [8, 13],
      14: [8, 14],
      15: [8, 15],
      16: [8, 16],
      17: [8, 17],
      18: [8, 18],
      19: [8, 19],
      20: [8, 20],
      21: [8, 21],
      22: [8, 22],
      23: [8, 23],
      24: [8, 24],
      25: [8, 25],
      26: [8, 26],
      27: [8, 27],
      28: [8, 28],
      29: [8, 28],
      30: [8, 29],
      31: [8, 30],
      32: [8, 31],
    },
    9: { // Fifth Astral Moon -> September
      1: [9, 1],
      2: [9, 2],
      3: [9, 3],
      4: [9, 4],
      5: [9, 5],
      6: [9, 6],
      7: [9, 7],
      8: [9, 7],
      9: [9, 8],
      10: [9, 9],
      11: [9, 10],
      12: [9, 11],
      13: [9, 12],
      14: [9, 13],
      15: [9, 14],
      16: [9, 15],
      17: [9, 16],
      18: [9, 17],
      19: [9, 18],
      20: [9, 19],
      21: [9, 20],
      22: [9, 21],
      23: [9, 22],
      24: [9, 23],
      25: [9, 24],
      26: [9, 25],
      27: [9, 26],
      28: [9, 27],
      29: [9, 28],
      30: [9, 28],
      31: [9, 29],
      32: [9, 30],
    },
    10: { // Fifth Umbral Moon -> October
      1: [10, 1],
      2: [10, 2],
      3: [10, 3],
      4: [10, 4],
      5: [10, 5],
      6: [10, 6],
      7: [10, 7],
      8: [10, 8],
      9: [10, 9],
      10: [10, 10],
      11: [10, 11],
      12: [10, 12],
      13: [10, 13],
      14: [10, 14],
      15: [10, 15],
      16: [10, 16],
      17: [10, 17],
      18: [10, 18],
      19: [10, 19],
      20: [10, 20],
      21: [10, 21],
      22: [10, 22],
      23: [10, 23],
      24: [10, 24],
      25: [10, 25],
      26: [10, 26],
      27: [10, 27],
      28: [10, 28],
      29: [10, 28],
      30: [10, 29],
      31: [10, 30],
      32: [10, 31],
    },
    11: { // Sixth Astral Moon -> November
      1: [11, 1],
      2: [11, 2],
      3: [11, 3],
      4: [11, 4],
      5: [11, 5],
      6: [11, 6],
      7: [11, 7],
      8: [11, 7],
      9: [11, 8],
      10: [11, 9],
      11: [11, 10],
      12: [11, 11],
      13: [11, 12],
      14: [11, 13],
      15: [11, 14],
      16: [11, 15],
      17: [11, 16],
      18: [11, 17],
      19: [11, 18],
      20: [11, 19],
      21: [11, 20],
      22: [11, 21],
      23: [11, 22],
      24: [11, 23],
      25: [11, 24],
      26: [11, 25],
      27: [11, 26],
      28: [11, 27],
      29: [11, 28],
      30: [11, 28],
      31: [11, 29],
      32: [11, 30],
    },
    12: { // Sixth Umbral Moon -> December
      1: [12, 1],
      2: [12, 2],
      3: [12, 3],
      4: [12, 4],
      5: [12, 5],
      6: [12, 6],
      7: [12, 7],
      8: [12, 8],
      9: [12, 9],
      10: [12, 10],
      11: [12, 11],
      12: [12, 12],
      13: [12, 13],
      14: [12, 14],
      15: [12, 15],
      16: [12, 16],
      17: [12, 17],
      18: [12, 18],
      19: [12, 19],
      20: [12, 20],
      21: [12, 21],
      22: [12, 22],
      23: [12, 23],
      24: [12, 24],
      25: [12, 25],
      26: [12, 26],
      27: [12, 27],
      28: [12, 28],
      29: [12, 28],
      30: [12, 29],
      31: [12, 30],
      32: [12, 31],
    },
  };

  private static readonly MONTH_NAMES = [
    "January",
    "February",
    "March",
    "April",
    "May",
    "June",
    "July",
    "August",
    "September",
    "October",
    "November",
    "December",
  ];

  public static convertToGregorian(eorzeanNameday: string): string | null {
    try {
      const parsed = this.parseEorzeanNameday(eorzeanNameday);
      if (!parsed) {
        return null;
      }

      const { moon, sun } = parsed;
      const gregorian = this.SUN_TO_GREGORIAN[moon]?.[sun];
      if (!gregorian) {
        return null;
      }

      const [month, day] = gregorian;
      const monthName = this.MONTH_NAMES[month - 1];
      const daySuffix = this.getDaySuffix(day);

      return `${daySuffix} ${monthName}`;
    } catch (_error) {
      return null;
    }
  }

  private static parseEorzeanNameday(nameday: string): { moon: number; sun: number } | null {
    const match = nameday.match(
      /(\d+)(?:st|nd|rd|th)\s+Sun\s+of\s+the\s+(\d+)(?:st|nd|rd|th)\s+(Astral|Umbral)\s+Moon/i,
    );
    if (!match) {
      return null;
    }

    const sun = parseInt(match[1], 10);
    const moonOrdinal = parseInt(match[2], 10);
    const moonType = match[3].toLowerCase();

    let moon: number;
    if (moonType === "astral") {
      moon = (moonOrdinal - 1) * 2 + 1;
    } else {
      moon = moonOrdinal * 2;
    }

    if (moon < 1 || moon > 12 || sun < 1 || sun > 32) {
      return null;
    }

    return { moon, sun };
  }

  private static getDaySuffix(day: number): string {
    if (day >= 11 && day <= 13) {
      return `${day}th`;
    }

    const lastDigit = day % 10;
    switch (lastDigit) {
      case 1:
        return `${day}st`;
      case 2:
        return `${day}nd`;
      case 3:
        return `${day}rd`;
      default:
        return `${day}th`;
    }
  }
}
