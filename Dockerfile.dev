FROM denoland/deno:2.5.6

# Install native build deps (same as your prod setup)
RUN apt-get update && apt-get install -y \
    build-essential \
    libcairo2-dev \
    libgif-dev \
    libjpeg-dev \
    libpango1.0-dev \
    librsvg2-dev \
    fonts-roboto \
    fonts-liberation \
    fontconfig \
    && rm -rf /var/lib/apt/lists/*

RUN mkdir -p /usr/share/fonts/custom
RUN fc-cache -fv

WORKDIR /app

# Copy only config files for caching
COPY deno.json deno.lock* ./

# Install npm:canvas
RUN deno install --allow-scripts=npm:canvas

# Copy fonts directory
COPY fonts/ /app/fonts/