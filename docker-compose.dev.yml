services:
  mysql:
    image: mysql:8.0
    container_name: naago-mysql-dev
    restart: unless-stopped
    env_file:
      - .env
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASS}
    ports:
      - "${DB_PORT}:3306"
    volumes:
      - mysql_data_dev:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - naago-network

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: naago-phpmyadmin-dev
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    env_file:
      - .env
    environment:
      PMA_HOST: mysql
      PMA_PORT: ${DB_PORT}
      PMA_USER: ${DB_USER}
      PMA_PASSWORD: ${DB_PASS}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    ports:
      - "${PMA_PORT}:80"
    networks:
      - naago-network

  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: naago-app-dev
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    entrypoint: [
      "/bin/bash",
      "-c",
      "deno run --allow-all src/database/migrate.ts && tail -f /dev/null",
    ]
    volumes:
      - ./src:/app/src
      - ./deno.json:/app/deno.json
      - ./deno.lock:/app/deno.lock
      - ./DEV.md:/app/DEV.md
      - ./README.md:/app/README.md
      - ./TERMS_OF_SERVICE.md:/app/TERMS_OF_SERVICE.md
      - ./PRIVACY_POLICY.md:/app/PRIVACY_POLICY.md
      - ./drizzle.config.ts:/app/drizzle.config.ts
    env_file:
      - .env
    environment:
      IS_PROD: false
    ports:
      - "3000:3000"
    networks:
      - naago-network

volumes:
  mysql_data_dev:

networks:
  naago-network:
